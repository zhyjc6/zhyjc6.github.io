# ARP欺骗实验

## 一、ARP协议简介

在介绍[arp协议](https://baike.baidu.com/item/ARP/609343)之前，我们先来了解一下[IP地址](https://baike.baidu.com/item/IP/224599?fromtitle=IP%E5%9C%B0%E5%9D%80&fromid=150859)和[MAC地址](https://baike.baidu.com/item/MAC%E5%9C%B0%E5%9D%80)：

- ip地址(ipv4--32位，ipv6-128位)
  - IP地址**（Internet Protocol Address）**，全称互联网协议地址，意思是分配给用户上网使用的网际协议的设备的数字标签，分为IPv4与IPv6两大类，但是也有其他不常用的小分类。
  - 位于[OSI模型](https://baike.baidu.com/item/OSI模型)中第三层网络层
  - 逻辑层面的地址，唯一标识一个网络位置
- mac地址(48位)
  - MAC地址（**Media Access Control Address）**，直译为媒体存取控制位址，也称为物理地址（Physical Address）
  - 位于[OSI模型](https://baike.baidu.com/item/OSI模型)中第二层数据链路层
  - 物理层面的地址，唯一标识一个网络设备



由于IP地址（IPv4，32位，逻辑地址）和mac地址（48位，物理地址）格式不同、性质不同，它们之间不存在简单的映射关系；并且随着主机的加入和退出，IP地址和硬件地址的映射还会发生变化。

这个时候呢人们就想到了一个办法：在主机ARP高速缓冲中，存放一个从IP地址到硬件地址的映射表，这个映射表会经常动态更新 （新增或超时删除），这就是**ARP（Address Resolution Protocol）地址解析协议**





## 二、ARP协议工作过程

1. 主机A想和主机B通信，就先在主机A的ARP高速缓冲中，查看有无主机B的IP地址。如果有，就查出主机B对应的MAC地址。如果没有，主机A会发送一个ARP请求广播包，此包内包含着主机B的IP地址。本局域网上的所有主机都将收到这个ARP请求。

2. 除了主机B，其余主机都不理睬这个ARP请求。主机B在ARP请求分组中看到自己的IP地址，就向主机A发送包含自己硬件地址的ARP响应分组。同时为了提高效率，主机B还把主机A的IP地址和MAC地址的映射关系保存到自己的高速缓存中。

3. 主机A收到主机B的ARP响应分组后，就在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射。这样，主机A、B都有了彼此的IP和硬件地址，双方可以通信了！

   



## 三、ARP协议的安全问题

- ARP协议是建立在**信任**局域网内所有结点的基础上的，这使得它高效但却不安全。
- ARP协议是**无状态**的协议，不会检查自己是否发过请求包，只要收到目标MAC是自己的ARP响应数据包或ARP广播包，都会接受并缓存。
- ARP协议**没有认证机制**，只要接收到的协议包是有效的，主机就无条件地根据协议包的内容刷新本机ARP缓存，并不检查该协议包的合法性。
- <u>因此攻击者可以随时发送虚假ARP包更新被攻击主机上的ARP缓存，进行地址欺骗或拒绝服务攻击。</u>





## 四、ARP相关协议及应用 

1. **RARP（反向ARP ）** 
   - 局域网的物理机器从网关服务器的 ARP 表或者缓存上根据MAC地址请求其 IP 地址，广泛用于获取无盘工作站的IP地址。
2. **代理ARP** 
   - 通过使用一个主机（通常为router），来作为指定的设备对另 一设备的ARP请求作出应答。
   - 例如，主机PC1（192.168.20.66/24）需要向主机PC2（192.168.20.20/24）发送报文，因为主机PC1不知道[子网](https://baike.baidu.com/item/子网)的存在且和目标主机PC2在同一主网络网段，所以主机PC1将发送ARP协议请求广播报文来请求192.168.20.20的MAC地址。这时，路由器将识别出报文的目标地址属于另一个子网，因此向请求主机回复**自己**的硬件地址（0004.dd9e.cca0）。之后，PC1将发往PC2的数据包都发往MAC地址0004.dd9e.cca0（路由器的接口E0/0），由路由器将数据包转发到目标主机PC2。（接下来路由器将为PC2做同样的代理发送数据包的工作）。
3. **无故ARP （Gratuitous ARP，GARP）** 
   - 主机有时会使用自己的IP地址作为目标地址发送ARP请求。主要用来检测IP的地址是否有冲突。
4. **ARP欺骗的正当用途**
   1. 在一个需要登录的网上中，让未登录的计算机将其浏览网页强制转向到登录页面，以便登录后才可使用网上。
   2. 另外有些设有备援机制的网上设备或服务器，亦需要利用ARP欺骗以在设备出现故障时将讯务导到备用的设备上。



## 五、ARP欺骗攻击原理

### MAC flooding

1. **原理**
   - 攻击者能让目标网络中的交换机不断泛洪大量不同源MAC地址的数据包，导致交换机内存不足以存放正确的MAC地址和物理端口号相对应的关系表。
2. **效果**
   - 如果攻击成功，交换机会降级为集线器（所有新进入交换机的数据包会不经过交换机处理直接广播到所有的端口）。攻击者和目标连接在同一个集线器时，攻击者可设置网卡为混杂模 式，窃听所有数据帧。
3. **过程**
   - 向目标交换机发送大量不同源MAC地址的数据包，使得交换机内存不足以存放正确的MAC地址和物理端口号的映射关系。交换机因此降级到集线器模式， 数据包被广播到所有的端口， 攻击者从而能够嗅探网络内信息。



### 中间人攻击（MIM, Man In the Middle）

1. **原理**

   中间人C接收并转发A和B的消息达到嗅探的目的

2. **效果**

   攻击成功后， 主机A发送给主机B的数据包被转发给主机C，主机B发送给主机A的数据包也被转发给主机C，于是A、B之间的数据均被C嗅探。攻击者C会转发重定向到自己的数据包到正确位置，因此A和B没有察觉到嗅探的存在。

3. **过程**

   攻击者C向目标发送虚假应答包， 告诉主机A“主机B的MAC地址是MacC”，告诉主机B“主机A的MAC地址 是MacC”。

   成功后， 主机A发送给主机B的数据包被 转发给主机C，
   主机B发送给主机A的数据包也被 转发给主机C，
   于是A、B之间的数据均被C嗅探。
   攻击者C会转发重定向到自己的数据包到正确位置，因此A和B不会察觉到嗅探的存在。





## 六、ARP欺骗防范技术

1. 静态ARP绑定

   最理想的防制方法是网上内的每台计算机的ARP一律改用静态的方式，不过这在大型的网上是不可行的，因为需要经常更新每台计算机的ARP表。

   

2. ARP防护软件

   有一些软件可监听网上上的ARP回应，若侦测出有不正常变动时可发送邮箱通知管理者。例如UNIX平台的[Arpwatch](https://baike.baidu.com/item/Arpwatch)以及Windows上的XArp v2或一些网上设备的Dynamic ARP inspection功能。

   

3. ARP防护功能的路由器

   有些网络设备可借由[DHCP](https://baike.baidu.com/item/DHCP)保留网络上各计算机的MAC地址，在伪造的ARP数据包发出时即可侦测到。此方式已在一些厂牌的网络设备产品所支持。





## 七、ARP欺骗攻击工具实验







## 八、ARP欺骗攻击编程实验





